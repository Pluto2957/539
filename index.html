<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 æ™ºèƒ½æ“ç›¤ç³»çµ± (Winner Removal Ver.)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- æ¥µç°¡æ¨£å¼å€ (Lite) --- */
        body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; font-size: 14px; }
        h1, h2 { margin: 0 0 10px 0; font-weight: normal; color: #fff; border-bottom: 1px solid #333; padding-bottom: 5px; }
        h1 { font-size: 20px; text-align: center; margin-bottom: 15px; letter-spacing: 1px; color: #90caf9; }
        h2 { font-size: 16px; margin-top: 0; color: #81d4fa; display: flex; justify-content: space-between; align-items: center;}

        .container { max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .box { background: #1e1e1e; border: 1px solid #333; padding: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        button { cursor: pointer; padding: 6px 12px; border: 1px solid #444; background: #2c2c2c; color: #fff; font-size: 13px; border-radius: 4px; transition: 0.2s; }
        button:hover { background: #404040; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.active { background: #1565c0; border-color: #0d47a1; font-weight: bold; box-shadow: 0 0 8px rgba(21, 101, 192, 0.5); }
        
        .btn-reset { background: #b71c1c; border-color: #7f0000; }
        .btn-fetch { width: 100%; padding: 12px; background: #2e7d32; border-color: #1b5e20; font-weight: bold; margin-top: 10px; font-size: 14px; }
        .btn-switch { background: #0277bd; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #121212; padding: 8px; border-radius: 4px; border: 1px solid #333; }
        .status-text { font-weight: bold; font-size: 12px; }
        .loading { color: #ffd600; } .success { color: #69f0ae; } .syncing { color: #40c4ff; }
        
        .progress-container { height: 3px; background: #333; width: 100%; margin-top: 5px; overflow: hidden; border-radius: 2px; }
        .progress-fill { height: 100%; background: #40c4ff; width: 0%; transition: width 0.3s; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media(min-width: 768px) { .dashboard-grid { grid-template-columns: 2fr 1fr; } }

        .control-panel { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; background: #252525; padding: 8px; border-radius: 4px; border: 1px solid #333; }
        input, select { background: #121212; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 3px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; }
        .stat-item { background: #252525; padding: 8px; border: 1px solid #333; border-radius: 4px; }
        .stat-label { font-size: 11px; color: #aaa; display: block; margin-bottom: 4px; }
        .stat-val { font-size: 15px; font-weight: bold; }
        .val-win { color: #69f0ae; } .val-loss { color: #ff5252; }

        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; white-space: nowrap; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
        th { background: #252525; color: #90caf9; }
        tr:nth-child(even) { background: #1a1a1a; }
        
        .num-ball { display: inline-block; width: 22px; height: 22px; line-height: 22px; border-radius: 50%; background: #333; margin: 0 1px; font-size: 11px; color: #bbb;}
        .num-hit { background: #ffd600; color: #000; font-weight: bold; box-shadow: 0 0 5px rgba(255, 214, 0, 0.6); }
        .num-excluded { text-decoration: line-through; color: #ff5252; font-size: 10px; margin-right: 2px;}

        .pred-balls { display: flex; justify-content: center; gap: 8px; margin: 15px 0; flex-wrap: wrap; }
        .pred-ball { background: linear-gradient(135deg, #ff6f00, #ff8f00); color: white; width: 36px; height: 36px; line-height: 36px; text-align: center; border-radius: 50%; font-weight: bold; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .mode-b .pred-ball { background: linear-gradient(135deg, #6a1b9a, #8e24aa); }

        .loading-overlay { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; flex-direction: column; z-index: 10; backdrop-filter: blur(2px); }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 999; }
        .modal-box { background: #222; padding: 20px; border: 1px solid #444; width: 300px; text-align: center; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }

        .tag-removed { font-size: 10px; padding: 2px 4px; background: #333; border: 1px solid #ff5252; color: #ff5252; border-radius: 3px; margin-left: 5px; }
    </style>
</head>
<body class="mode-a">

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modalTitle">æ¨™é¡Œ</h3>
        <p id="modalMsg" style="line-height: 1.5; color: #ccc;">è¨Šæ¯</p>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<div class="container">
    <header>
        <h1 id="app-title">Lotto 539 æ™ºèƒ½æ“ç›¤ç³»çµ± (Winner Removal)</h1>
        <div style="text-align:center; margin-bottom:5px;">
            <button class="active" id="btnModeA" onclick="setMode('A')">ç©æ³• 1: ç­–ç•¥ B+ (5é¸)</button>
            <button id="btnModeB" onclick="setMode('B')">ç©æ³• 2: è´å®¶ä¸çºŒæŠ± (8é¸)</button>
        </div>
    </header>

    <div class="box" style="padding:10px;">
        <div class="status-bar" style="border:none; padding:0; background:transparent;">
            <div>
                <span id="statusText" class="loading">â³ ç³»çµ±åˆå§‹åŒ–...</span>
                <span id="dataInfoBlock" style="font-size:11px; color:#888; margin-left:10px;"></span>
            </div>
            <button class="btn-reset" onclick="resetAndReloadData()">é‡ç½®æ•¸æ“šåº«</button>
        </div>
        <div class="progress-container">
            <div class="progress-fill" id="statusProgressBar"></div>
        </div>
    </div>

    <div id="manualInputSection" class="box" style="display:none; border-color:#b71c1c; background:rgba(183, 28, 28, 0.1);">
        <p style="margin:0 0 10px 0; font-weight:bold; color:#ff8a80; text-align:center;">âš ï¸ è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æœ€æ–°çè™Ÿ</p>
        <div style="display:flex; gap:8px; justify-content:center;">
            <input type="number" id="m1" style="width:40px; text-align:center;"><input type="number" id="m2" style="width:40px; text-align:center;">
            <input type="number" id="m3" style="width:40px; text-align:center;"><input type="number" id="m4" style="width:40px; text-align:center;">
            <input type="number" id="m5" style="width:40px; text-align:center;">
            <button onclick="manualStart()" style="background:#d32f2f;">ç¢ºèªè¼¸å…¥</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="box" style="position:relative;">
            <div class="loading-overlay" id="loadingBar">
                <span style="font-size:16px; font-weight:bold; color:white;">AI é‹ç®—ä¸­...</span>
                <div style="width:150px; height:4px; background:#555; margin-top:10px; border-radius:2px;"><div id="progressFill" style="height:100%; width:0%; background:#40c4ff;"></div></div>
                <div style="font-size:12px; color:#aaa; margin-top:5px;">æ­£åœ¨åŸ·è¡Œç‹€æ…‹å›æ¸¬...</div>
            </div>

            <h2 id="strategyTitle">ç­–ç•¥å›æ¸¬å ±å‘Š</h2>
            <div class="control-panel">
                <span style="color:#bbb;">ç­–ç•¥æ ¸å¿ƒ:</span>
                <select id="strategySelect" style="flex:1;" disabled>
                    <option value="current">æ™ºèƒ½è‡ªå‹•é…ç½®</option>
                </select>
                <span style="color:#bbb;">å€ç‡:</span>
                <input type="number" id="baseUnit" value="1" min="1" style="width:50px; text-align:center;">
                <button class="btn-switch" onclick="runAnalysisWithLoading()">åŸ·è¡Œå›æ¸¬</button>
            </div>

            <div class="stats-grid">
                <div class="stat-item"><span class="stat-label">ç´¯ç©æ·¨åˆ©</span><span class="stat-val" id="st-profit">--</span></div>
                <div class="stat-item"><span class="stat-label">ROI (æŠ•å ±ç‡)</span><span class="stat-val" id="st-roi">--%</span></div>
                <div class="stat-item"><span class="stat-label">å‹ç‡ (ä¸è™§æ)</span><span class="stat-val" id="st-winrate">--%</span></div>
                <div class="stat-item"><span class="stat-label">äº¤æ˜“æœŸæ•¸</span><span class="stat-val" id="st-count">--</span></div>
                <div class="stat-item"><span class="stat-label">æœ€é«˜é€£å‹</span><span class="stat-val val-win" id="st-max-win">--</span></div>
                <div class="stat-item"><span class="stat-label">æœ€é«˜é€£æ•—</span><span class="stat-val val-loss" id="st-max-loss">--</span></div>
                <div class="stat-item"><span class="stat-label">MDD (å›æ’¤)</span><span class="stat-val val-loss" id="st-mdd">--</span></div>
                <div class="stat-item"><span class="stat-label">è³‡æ–™å€é–“</span><span class="stat-val" id="real-test-count-disp" style="font-size:12px;">--</span></div>
            </div>
            <div id="strategy-desc" style="font-size:12px; color:#888; margin-top:10px; padding:10px; background:rgba(255,255,255,0.05); border-radius:4px; line-height:1.4;">
                è¼‰å…¥ä¸­...
            </div>
        </div>

        <div class="box" style="display:flex; flex-direction:column;">
            <h2>ä¸‹æœŸ AI è¨Šè™Ÿ</h2>
            <div style="text-align:center; padding:15px 0; border-bottom:1px dashed #444; flex-grow:1;">
                <div style="font-size:13px; color:#aaa;">é æ¸¬é–‹çæ—¥</div>
                <div id="nextDrawDate" style="font-size:20px; font-weight:bold; color:#fff; margin:5px 0;">--/--</div>
                <div id="nextWeekday" style="color:#40c4ff; font-size:14px;">é€±--</div>
                
                <div id="prediction-panel" style="margin-top:20px;">
                    <div id="prediction-content" style="color:#777;">ç­‰å¾…é‹ç®—...</div>
                </div>
            </div>
            <button id="btnFetch" class="btn-fetch" onclick="forceFetchData()">ğŸ“¡ æŠ“å–æœ€æ–°é–‹çæ•¸æ“š</button>
        </div>
    </div>

    <div class="box">
        <h2>è©³ç´°äº¤æ˜“ç´€éŒ„</h2>
        <div class="table-wrap">
            <table id="historyTable">
                <thead>
                    <tr><th>æ—¥æœŸ</th><th>é–‹çè™Ÿç¢¼</th><th>ç­–ç•¥é æ¸¬</th><th>æˆæœ¬</th><th>æç›Š (Net)</th><th>çµæœ</th></tr>
                </thead>
                <tbody id="fullHistoryBody"></tbody>
            </table>
        </div>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:15px; align-items:center;">
            <button onclick="changePage(-1)">â—€ ä¸Šä¸€é </button>
            <span id="pageInfo" style="color:#aaa; font-size:12px;">1 / 1</span>
            <button onclick="changePage(1)">ä¸‹ä¸€é  â–¶</button>
        </div>
    </div>

    <div class="box">
        <h2>è³‡é‡‘æ¬Šç›Šæ›²ç·š (Equity Curve)</h2>
        <div style="height: 300px; width: 100%;">
            <canvas id="equityChart"></canvas>
        </div>
    </div>
</div>

<script>
    // ==========================================
    //  å…¨åŸŸé…ç½®
    // ==========================================
    const DRIVE_FILE_ID = '1K2CNRIE97NRfJrzKiG8Adcz_tFeYHPlm';
    const STORAGE_KEY = 'lotto539_data_winner_removal_v1';
    const BASE_URL = "https://www.lotto-8.com/listlto539.asp";
    const CRAWL_PAGES = 3;
    
    // æ¨¡å¼ A: åŸå§‹ B+ (5é¸)
    const MODE_A_SETTINGS = {
        label: "ç­–ç•¥ B+ (çµæ§‹åŒ–å„ªé¸)",
        numsToPick: 5,
        cost: 2000,
        payouts: { 2: 5300, 3: 72900, 4: 1009800, 5: 1009800 }, 
        desc: "æ¬Šé‡: çŸ­/ä¸­é€±æœŸ + éºæ¼å€¼ | æ¿¾ç¶²: å¥‡å¶/å°¾æ•¸/å€é–“å¹³è¡¡"
    };

    // æ¨¡å¼ B: è´å®¶ä¸çºŒæŠ± (8é¸)
    const MODE_B_SETTINGS = {
        label: "è´å®¶ä¸çºŒæŠ± (Winner Removal)",
        numsToPick: 8,
        cost: 3030,
        // 1ä¸­3420, 2ä¸­3420, 3ä¸­7410, 4ä¸­97800, 5ä¸­432000
        payouts: { 1: 3420, 2: 3420, 3: 7410, 4: 97800, 5: 432000 },
        desc: "é›†æˆç­–ç•¥(å‹•é‡/é—œè¯/éºæ¼/å€é–“) + å‹•æ…‹æ¿¾ç¶²ï¼šè‹¥ä¸ŠæœŸç²åˆ©(>0)ï¼Œç•¶æœŸå¼·åˆ¶å‰”é™¤ä¸ŠæœŸä¸­çè™Ÿç¢¼ (è´å®¶ä¼‘æ¯)ã€‚"
    };
    
    let fullData = [];
    let globalTradeHistory = []; 
    let currentMode = 'A'; 
    let currentPage = 1;
    const ITEMS_PER_PAGE = 10;
    let equityChartInstance = null;
    let lastRoundExcluded = []; // ä¾›é æ¸¬ä½¿ç”¨ (ç´€éŒ„æœ€æ–°ä¸€æœŸæ˜¯å¦è§¸ç™¼å‰”é™¤)

    // ==========================================
    //  åˆå§‹åŒ–
    // ==========================================
    window.onload = initSystem;

    function setStatus(text, type = 'loading') {
        const el = document.getElementById('statusText');
        el.innerText = text;
        el.className = 'status-text ' + type;
        const bar = document.getElementById('statusProgressBar');
        if(type === 'loading' || type === 'syncing') bar.style.width = '60%';
        else if (type === 'success') {
            bar.style.width = '100%';
            setTimeout(() => { bar.style.width = '0%'; }, 800);
        }
    }

    async function showModal(type, title, msg) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerHTML = msg.replace(/\n/g, '<br>');
            const actionsEl = document.getElementById('modalActions');
            actionsEl.innerHTML = ''; 
            
            if (type === 'confirm') {
                const btnCancel = document.createElement('button');
                btnCancel.innerText = 'å–æ¶ˆ';
                btnCancel.onclick = () => { modal.style.display='none'; resolve(false); };
                const btnConfirm = document.createElement('button');
                btnConfirm.innerText = 'ç¢ºå®š';
                btnConfirm.style.background = '#b71c1c';
                btnConfirm.onclick = () => { modal.style.display='none'; resolve(true); };
                actionsEl.appendChild(btnCancel); actionsEl.appendChild(btnConfirm);
            } else {
                const btnOk = document.createElement('button');
                btnOk.innerText = 'å¥½';
                btnOk.onclick = () => { modal.style.display='none'; resolve(true); };
                actionsEl.appendChild(btnOk);
            }
            modal.style.display = 'flex';
        });
    }

    // ==========================================
    //  Data Layer
    // ==========================================
    async function fetchCloudData() {
        setStatus("åŒæ­¥é›²ç«¯è³‡æ–™åº«...", 'syncing');
        const driveUrl = `https://drive.google.com/uc?export=download&id=${DRIVE_FILE_ID}`;
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(driveUrl)}`;
        try {
            let res = await fetch(proxyUrl);
            if (!res.ok) throw new Error("Network error");
            return await res.json();
        } catch (error) {
            console.warn("Cloud fetch failed", error);
            return []; 
        }
    }

    async function initSystem() {
        let cloudData = await fetchCloudData();
        let localData = [];
        const localStr = localStorage.getItem(STORAGE_KEY);
        if (localStr) { try { localData = JSON.parse(localStr); } catch(e) {} }

        let mergedMap = new Map();
        if (Array.isArray(cloudData)) cloudData.forEach(item => mergedMap.set(item.date, item));
        if (Array.isArray(localData)) localData.forEach(item => mergedMap.set(item.date, item));

        fullData = Array.from(mergedMap.values());
        fullData.sort((a,b) => new Date(b.date) - new Date(a.date)); // [0] is Newest
        localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
        
        runAnalysisWithLoading();
        forceFetchData(); 
    }

    async function resetAndReloadData() {
        if (!await showModal('confirm', 'è³‡æ–™é‡ç½®', 'ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å¿«å–ä¸¦é‡æ–°ä¸‹è¼‰å—ï¼Ÿ')) return;
        localStorage.removeItem(STORAGE_KEY);
        fullData = [];
        await initSystem();
        await showModal('success', 'å®Œæˆ', 'ç³»çµ±å·²é‡ç½®å®Œç•¢ã€‚');
    }

    async function forceFetchData() {
        setStatus("æª¢æŸ¥é–‹çæ›´æ–°...", 'syncing');
        const proxies = [
            url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&timestamp=${Date.now()}`,
            url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
        ];
        let newData = [];
        let latestDate = (fullData.length > 0) ? fullData[0].date : "2000/01/01";
        
        try {
            for (let i = 1; i <= CRAWL_PAGES; i++) {
                let targetUrl = i === 1 ? BASE_URL : `${BASE_URL}?indexpage=${i}&orderby=new`;
                let html = null;
                for (let proxy of proxies) {
                    try {
                        let res = await fetch(proxy(targetUrl));
                        let content = res.url.includes("allorigins") ? (await res.json()).contents : await res.text();
                        if (content && content.length > 500) { html = content; break; }
                    } catch(e){}
                }
                if(html) {
                    let parsed = parseHtml(html);
                    parsed.forEach(row => {
                        if(new Date(row.date) > new Date(latestDate)) newData.push(row);
                    });
                }
            }
            if(newData.length>0) {
                fullData = [...newData, ...fullData];
                fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
                setStatus(`æ›´æ–°æˆåŠŸ: +${newData.length} æœŸ`, 'success');
                runAnalysisWithLoading();
            } else {
                setStatus("å·²æ˜¯æœ€æ–°è³‡æ–™", 'success');
            }
        } catch(e) { 
            setStatus("é€£ç·šå¤±æ•—", 'loading');
            document.getElementById('manualInputSection').style.display = 'block';
        }
    }

    function parseHtml(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        let results = [];
        doc.querySelectorAll("tr").forEach(row => {
            const text = row.innerText.trim();
            const dMatch = text.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
            if (dMatch) {
                let nums = text.match(/\d{2}/g);
                if (nums && nums.length >= 5) {
                    let valid = [];
                    for (let i = nums.length - 1; i >= 0; i--) {
                        let n = parseInt(nums[i]);
                        if (n >= 1 && n <= 39 && !valid.includes(n)) valid.unshift(n);
                        if (valid.length === 5) break;
                    }
                    if (valid.length === 5) {
                        let dateStr = `${dMatch[1]}/${dMatch[2].padStart(2, '0')}/${dMatch[3].padStart(2, '0')}`;
                        results.push({ date: dateStr, numbers: valid });
                    }
                }
            }
        });
        return results;
    }

    function manualStart() {
        let inputs = [1,2,3,4,5].map(i => parseInt(document.getElementById('m'+i).value));
        if(inputs.some(isNaN) || inputs.some(n=>n<1||n>39)) { showModal('error','éŒ¯èª¤','è«‹è¼¸å…¥æ­£ç¢ºè™Ÿç¢¼'); return; }
        let today = new Date();
        let dateStr = `${today.getFullYear()}/${(today.getMonth()+1).toString().padStart(2,'0')}/${today.getDate().toString().padStart(2,'0')}`;
        fullData.unshift({ date: dateStr, numbers: inputs });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
        document.getElementById('manualInputSection').style.display = 'none';
        runAnalysisWithLoading();
    }

    // ==========================================
    //  Core Logic: ç­–ç•¥é‹ç®—
    // ==========================================

    function getCombinations(arr, k) {
        let i, subI, ret = [], sub, next;
        for (i = 0; i < arr.length; i++) {
            if (k === 1) ret.push([arr[i]]);
            else {
                sub = getCombinations(arr.slice(i + 1), k - 1);
                for (subI = 0; subI < sub.length; subI++) {
                    next = sub[subI]; next.unshift(arr[i]); ret.push(next);
                }
            }
        }
        return ret;
    }

    // ç­–ç•¥ A: åŸå§‹ B+
    function getStrategyAPrediction(historyVals) {
        const params = { w_short: 1.0, w_mid: 3.0, w_repeater: 0.0, w_recent: 1.0, w_cold: 3.0 };
        let scores = {};
        let flatShort = [], flatMid = [];
        if(historyVals.length >= 5) historyVals.slice(0,5).forEach(arr => flatShort.push(...arr));
        if(historyVals.length >= 12) historyVals.slice(0,12).forEach(arr => flatMid.push(...arr));
        
        let gapMap = {};
        for(let i = historyVals.length-1; i>=0; i--) {
            historyVals[i].forEach(n => gapMap[n] = i); 
        }

        for (let num = 1; num <= 39; num++) {
            let s = 0;
            s += flatShort.filter(x=>x===num).length * params.w_short;
            s += flatMid.filter(x=>x===num).length * params.w_mid;
            let gap = gapMap[num] !== undefined ? gapMap[num] : 999;
            if(gap === 0) s += params.w_repeater;
            else if(gap <= 4) s += params.w_recent;
            else if(gap > 10) s += params.w_cold;
            scores[num] = s;
        }

        let sortedNums = Object.keys(scores).map(n=>parseInt(n)).sort((a,b)=>scores[b]-scores[a]).slice(0,14);
        let bestCombo = null, maxScore = -Infinity;
        let combos = getCombinations(sortedNums, 5);

        for (let combo of combos) {
            let odds = combo.filter(n=>n%2!==0).length;
            if (odds !== 2 && odds !== 3) continue;
            let tails = {}; combo.forEach(n => tails[n%10] = (tails[n%10]||0)+1);
            if (Object.values(tails).some(c => c > 2)) continue;
            let segs = [0,0,0,0,0];
            combo.forEach(n => {
                if(n<=8) segs[0]++; else if(n<=16) segs[1]++; else if(n<=24) segs[2]++; else if(n<=32) segs[3]++; else segs[4]++;
            });
            if (segs.some(s=>s>2) || segs.filter(s=>s>0).length < 3) continue;
            let cs = combo.reduce((sum, n)=>sum+scores[n], 0);
            if (cs > maxScore) { maxScore = cs; bestCombo = combo; }
        }
        return (bestCombo || sortedNums.slice(0,5)).sort((a,b)=>a-b);
    }

    // ç­–ç•¥ B: é›†æˆç­–ç•¥ (å›å‚³å®Œæ•´æ’å 1-39)
    function getEnsembleRankedList(historyVals) {
        // historyVals: [Newest ... Oldest]
        // ç‚ºäº†ç¬¦åˆ Python ç¿’æ…£ï¼Œæˆ‘å€‘ç”¨ slice å– N æœŸ (index 0 is newest)

        function normalize(scoreObj) {
            let vals = Object.values(scoreObj);
            if(vals.length === 0) return {};
            let min = Math.min(...vals), max = Math.max(...vals);
            let res = {};
            for(let k in scoreObj) res[k] = (max === min) ? 0.5 : (scoreObj[k] - min) / (max - min);
            return res;
        }

        // 1. Momentum (è¿‘20æœŸ)
        let recent20 = historyVals.slice(0, 20).flat();
        let scores_mom = {};
        for(let n=1; n<=39; n++) scores_mom[n] = 0;
        recent20.forEach(n => scores_mom[n]++);

        // 2. Association (è¿‘50æœŸ)
        let subset50 = historyVals.slice(0, 50);
        let all_nums_50 = subset50.flat();
        let counts50 = {}; all_nums_50.forEach(n => counts50[n] = (counts50[n]||0)+1);
        let top_seeds = Object.keys(counts50).map(Number).sort((a,b)=>counts50[b]-counts50[a]).slice(0,3);

        let scores_assoc = {};
        for(let n=1; n<=39; n++) scores_assoc[n] = top_seeds.includes(n) ? 1000 : 0;
        subset50.forEach(nums => {
            if(nums.some(n => top_seeds.includes(n))) {
                nums.forEach(n => { if(!top_seeds.includes(n)) scores_assoc[n]++; });
            }
        });

        // 3. Omission (è¿‘200æœŸ freq, Max gap 300)
        let scores_miss = {};
        let current_omission = {};
        for(let n=1; n<=39; n++) {
            let gap = 300;
            let limit = Math.min(historyVals.length, 300);
            for(let i=0; i<limit; i++) {
                if(historyVals[i].includes(n)) { gap = i + 1; break; }
            }
            current_omission[n] = gap;
        }
        let subset200 = historyVals.slice(0, 200).flat();
        let counts200 = {}; subset200.forEach(n => counts200[n] = (counts200[n]||0)+1);
        for(let n=1; n<=39; n++) {
            let freq = counts200[n] || 0;
            let avg_gap = 200 / (freq + 1);
            scores_miss[n] = (freq > 0) ? (current_omission[n] / avg_gap) : 0;
        }

        // 4. Zone (è¿‘10æœŸ)
        let subset10 = historyVals.slice(0, 10);
        let zone_counts = {1:0, 2:0, 3:0, 4:0};
        subset10.flat().forEach(n => {
            if(n<=10) zone_counts[1]++; else if(n<=20) zone_counts[2]++; else if(n<=30) zone_counts[3]++; else zone_counts[4]++;
        });
        let scores_zone = {};
        let counts10 = {}; subset10.flat().forEach(n => counts10[n]=(counts10[n]||0)+1);
        for(let n=1; n<=39; n++) {
            let z_id = n<=10?1 : n<=20?2 : n<=30?3 : 4;
            scores_zone[n] = (counts10[n]||0) * (1 + (zone_counts[z_id] / 50.0));
        }

        // Aggregate
        let norm_mom = normalize(scores_mom);
        let norm_assoc = normalize(scores_assoc);
        let norm_miss = normalize(scores_miss);
        let norm_zone = normalize(scores_zone);

        let final_scores = {};
        for(let n=1; n<=39; n++) {
            final_scores[n] = (norm_mom[n]||0)*0.4 + (norm_assoc[n]||0)*0.3 + (norm_miss[n]||0)*0.15 + (norm_zone[n]||0)*0.15;
        }

        // Return sorted list (All 39 numbers)
        return Object.keys(final_scores).map(Number).sort((a,b) => final_scores[b] - final_scores[a]);
    }


    // ==========================================
    //  UI & Backtest Control
    // ==========================================
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btnModeA').className = mode === 'A' ? 'active' : '';
        document.getElementById('btnModeB').className = mode === 'B' ? 'active' : '';
        
        const settings = mode === 'A' ? MODE_A_SETTINGS : MODE_B_SETTINGS;
        document.body.className = mode === 'A' ? 'mode-a' : 'mode-b';
        document.getElementById('strategyTitle').innerText = settings.label;
        document.getElementById('strategy-desc').innerText = settings.desc;
        
        runAnalysisWithLoading();
    }

    function runAnalysisWithLoading() {
        const loading = document.getElementById('loadingBar');
        const fill = document.getElementById('progressFill');
        loading.style.display = 'flex';
        fill.style.width = '0%';
        
        setTimeout(() => { 
            fill.style.width = '80%';
            setTimeout(() => {
                const infoBlock = document.getElementById('dataInfoBlock');
                if (fullData.length > 0) infoBlock.innerText = `åº«å­˜: ${fullData.length} æœŸ`;
                
                let multiplier = parseFloat(document.getElementById('baseUnit').value) || 1;
                let res = runBacktest(fullData, multiplier, currentMode);
                
                updateStatBox(res);
                currentPage = 1;
                renderHistoryTable();
                updateEquityChart();
                predictNextDraw(); 
                
                fill.style.width = '100%';
                setTimeout(() => { loading.style.display = 'none'; }, 200);
            }, 100);
        }, 100);
    }

    function runBacktest(data, multiplier, mode) {
        globalTradeHistory = [];
        let totalCost = 0, totalNet = 0, winDays = 0, tradingDays = 0;
        let currentEquity = 0, peakEquity = 0, maxDrawdown = 0;
        let maxWin = 0, curWin = 0, maxLoss = 0, curLoss = 0;

        const settings = mode === 'A' ? MODE_A_SETTINGS : MODE_B_SETTINGS;
        const windowSize = 200; // Need efficient history

        if (data.length < windowSize + 1) return { net: 0 };

        // **é‡è¦**ï¼šç‚ºäº†å¯¦ç¾ã€Œè´å®¶ä¸çºŒæŠ±ã€ï¼Œæˆ‘å€‘å¿…é ˆä¾åº(å¾èˆŠåˆ°æ–°)é‹ç®—ï¼Œæ‰èƒ½çŸ¥é“ä¸Šä¸€æœŸçš„ç‹€æ…‹
        // data array is [Newest(0), ..., Oldest(N)]
        // So we iterate i from (length - window - 1) DOWN TO 0.
        
        let lastWinningNums = []; // ç´€éŒ„ä¸Šä¸€æœŸä¸­ççš„è™Ÿç¢¼ (for Mode B)

        for (let i = data.length - windowSize - 1; i >= 0; i--) {
            let historyData = data.slice(i + 1); 
            let historyVals = historyData.map(d => d.numbers);
            let targetDraw = data[i]; 
            
            let predicted = [];
            let excludedNums = [];

            if (mode === 'A') {
                predicted = getStrategyAPrediction(historyVals);
            } else {
                // Mode B: é›†æˆç­–ç•¥ + è´å®¶ä¸çºŒæŠ±
                let fullRanked = getEnsembleRankedList(historyVals);
                
                if (lastWinningNums.length > 0) {
                    // æ¿¾æ‰ä¸Šä¸€æœŸè´å®¶
                    excludedNums = lastWinningNums;
                    let filtered = fullRanked.filter(n => !lastWinningNums.includes(n));
                    predicted = filtered.slice(0, 8);
                } else {
                    predicted = fullRanked.slice(0, 8);
                }
            }

            let hits = predicted.filter(x => targetDraw.numbers.includes(x)).length;
            let cost = settings.cost * multiplier;
            let payout = (settings.payouts[hits] || 0) * multiplier;
            let dailyNet = payout - cost;

            // æ›´æ–°ç‹€æ…‹ for ä¸‹ä¸€è¼ª loop
            if (mode === 'B') {
                if (dailyNet > 0) {
                    // ç²åˆ©ï¼šè¨˜éŒ„ä¸­çè™Ÿç¢¼
                    lastWinningNums = predicted.filter(x => targetDraw.numbers.includes(x));
                } else {
                    // æ²’ç²åˆ©ï¼šé‡ç½®ï¼Œä¸‹æœŸä¸å‰”é™¤
                    lastWinningNums = [];
                }
            }

            // çµ±è¨ˆ (ç•¥)
            totalCost += cost; totalNet += dailyNet; currentEquity += dailyNet;
            if (currentEquity > peakEquity) peakEquity = currentEquity;
            let dd = currentEquity - peakEquity;
            if (dd < maxDrawdown) maxDrawdown = dd;

            if (dailyNet > 0) { winDays++; curWin++; curLoss=0; if(curWin>maxWin) maxWin=curWin; }
            else { curLoss++; curWin=0; if(curLoss>maxLoss) maxLoss=curLoss; }
            tradingDays++;

            globalTradeHistory.push({
                date: targetDraw.date,
                numbers: targetDraw.numbers,
                signal: predicted,
                excluded: excludedNums, // For display
                hits: hits,
                cost: cost,
                net: dailyNet,
                isWin: dailyNet > 0
            });
        }
        
        // ç‚ºäº† UI é¡¯ç¤ºï¼Œåè½‰ç‚º [æœ€æ–° -> æœ€èˆŠ]
        globalTradeHistory.reverse();
        
        // ç´€éŒ„ã€Œæœ€æ–°ä¸€æœŸã€çš„å‰”é™¤ç‹€æ…‹çµ¦é æ¸¬ä½¿ç”¨ (å› ç‚º loop çµæŸæ™‚ lastWinningNums æ˜¯é‡å° data[0] çš„çµæœ)
        // ä½†é€™è£¡ loop çµæŸæ™‚ï¼ŒlastWinningNums å·²ç¶“æ ¹æ“š data[0] (æœ€æ–°é–‹ç) çš„çµæœæ›´æ–°äº†
        // æ‰€ä»¥é€™æ­£æ˜¯æˆ‘å€‘é æ¸¬ã€ŒæœªçŸ¥ä¸‹ä¸€æœŸã€æ‰€éœ€è¦çš„å‰”é™¤åå–®
        lastRoundExcluded = (mode === 'B') ? lastWinningNums : [];

        return { cost: totalCost, net: totalNet, winDays: winDays, tradingDays: tradingDays, maxWin: maxWin, maxLoss: maxLoss, maxDrawdown: maxDrawdown };
    }

    function predictNextDraw() {
        if(fullData.length === 0) return;
        let historyVals = fullData.map(d => d.numbers);
        let prediction = [];
        let infoText = "";

        if (currentMode === 'A') {
            prediction = getStrategyAPrediction(historyVals);
        } else {
            // Mode B
            let fullRanked = getEnsembleRankedList(historyVals);
            
            if (lastRoundExcluded.length > 0) {
                // å‰”é™¤
                let filtered = fullRanked.filter(n => !lastRoundExcluded.includes(n));
                prediction = filtered.slice(0, 8);
                infoText = `<span style="color:#ff5252; font-size:12px;">âš ï¸ å·²å‰”é™¤ä¸ŠæœŸè´å®¶: ${lastRoundExcluded.map(n=>n<10?'0'+n:n).join(', ')}</span>`;
            } else {
                prediction = fullRanked.slice(0, 8);
                // æª¢æŸ¥æ˜¯å¦å› ç‚ºä¸ŠæœŸæ²’è³ºéŒ¢æ‰€ä»¥æ²’å‰”é™¤
                // é€™è£¡å¯ä»¥é¸æ“‡é¡¯ç¤º "ä¸ŠæœŸæœªç²åˆ©ï¼Œç„¡å‰”é™¤"
            }
        }
        
        let lastDate = new Date(fullData[0].date);
        let nextDate = new Date(lastDate);
        nextDate.setDate(lastDate.getDate() + 1);
        if(nextDate.getDay() === 0) nextDate.setDate(nextDate.getDate() + 1);
        
        let m = (nextDate.getMonth()+1).toString().padStart(2,'0');
        let d = nextDate.getDate().toString().padStart(2,'0');
        let w = "æ—¥ä¸€äºŒä¸‰å››äº”å…­"[nextDate.getDay()];
        
        document.getElementById('nextDrawDate').innerText = `${m}/${d}`;
        document.getElementById('nextWeekday').innerText = `é€±${w}`;
        
        let html = `
        <div style="margin-bottom:10px;">${infoText}</div>
        <div class="pred-balls">
            ${prediction.map(n => `<div class="pred-ball">${n<10?'0'+n:n}</div>`).join('')}
        </div>
        <div style="font-size:12px; color:#666; margin-top:10px;">
            ${currentMode==='A' ? 'ç­–ç•¥B+ (5é¸)' : 'è´å®¶ä¸çºŒæŠ± (8é¸)'} | 
            æˆæœ¬: $${(currentMode==='A'?MODE_A_SETTINGS.cost:MODE_B_SETTINGS.cost).toLocaleString()}
        </div>`;
        document.getElementById('prediction-content').innerHTML = html;
    }

    function updateStatBox(res) {
        document.getElementById('st-profit').innerText = `$${res.net.toLocaleString()}`;
        document.getElementById('st-profit').className = res.net > 0 ? "stat-val val-win" : "stat-val val-loss";
        document.getElementById('st-roi').innerText = (res.cost > 0 ? (res.net/res.cost*100).toFixed(1) : 0) + "%";
        document.getElementById('st-winrate').innerText = (res.tradingDays > 0 ? (res.winDays/res.tradingDays*100).toFixed(1) : 0) + "%";
        document.getElementById('st-count').innerText = res.tradingDays;
        document.getElementById('st-max-win').innerText = res.maxWin;
        document.getElementById('st-max-loss').innerText = res.maxLoss;
        document.getElementById('st-mdd').innerText = `$${Math.abs(res.maxDrawdown).toLocaleString()}`;
        document.getElementById('real-test-count-disp').innerText = "è¿‘ " + res.tradingDays + " æœŸ";
    }

    function renderHistoryTable() {
        const tbody = document.getElementById('fullHistoryBody');
        const pageInfo = document.getElementById('pageInfo');
        const totalItems = globalTradeHistory.length;
        const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
        
        tbody.innerHTML = '';
        pageInfo.innerText = `${currentPage} / ${totalPages} (å…± ${totalItems} ç­†)`;
        
        if(totalItems === 0) { tbody.innerHTML = '<tr><td colspan="6" style="padding:20px;">ç„¡äº¤æ˜“ç´€éŒ„</td></tr>'; return; }

        let start = (currentPage - 1) * ITEMS_PER_PAGE;
        let end = Math.min(start + ITEMS_PER_PAGE, totalItems);

        for (let i = start; i < end; i++) {
            let row = globalTradeHistory[i];
            let tr = document.createElement('tr');
            
            let numsHtml = row.numbers.map(n => {
                let hit = row.signal.includes(n);
                return `<span class="num-ball ${hit?'num-hit':''}">${n<10?'0'+n:n}</span>`;
            }).join('');
            
            let predHtml = row.signal.map(n => {
                let hit = row.numbers.includes(n);
                return `<span style="${hit?'color:#ffd600; font-weight:bold;':''}">${n<10?'0'+n:n}</span>`;
            }).join(', ');

            // å¦‚æœæœ‰å‰”é™¤ï¼Œé¡¯ç¤ºåœ¨é æ¸¬ä¸‹æ–¹
            if(row.excluded && row.excluded.length > 0) {
                predHtml += `<br><span class="num-excluded">å‰”é™¤:${row.excluded.join(',')}</span>`;
            }

            tr.innerHTML = `
                <td style="color:#666;">${row.date.slice(5)}</td>
                <td>${numsHtml}</td>
                <td style="font-size:12px; color:#4fc3f7;">${predHtml}</td>
                <td>$${row.cost.toLocaleString()}</td>
                <td style="color:${row.net>0?'#69f0ae':'#ff5252'}; font-weight:bold;">${row.net>0?'+':''}${row.net.toLocaleString()}</td>
                <td>${row.isWin ? '<span style="color:#69f0ae;">WIN</span>' : '<span style="color:#555;">LOSS</span>'}</td>
            `;
            tbody.appendChild(tr);
        }
    }

    function changePage(delta) {
        const totalPages = Math.ceil(globalTradeHistory.length / ITEMS_PER_PAGE);
        let newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderHistoryTable();
        }
    }

    function updateEquityChart() {
        const ctx = document.getElementById('equityChart').getContext('2d');
        let chronoHistory = [...globalTradeHistory].reverse();
        let labels = chronoHistory.map(d => d.date.slice(5)); 
        let data = [];
        let accum = 0;
        chronoHistory.forEach(d => { accum += d.net; data.push(accum); });
        
        if (equityChartInstance) equityChartInstance.destroy();
        
        let lineColor = currentMode === 'A' ? '#0277bd' : '#8e24aa'; 
        let fillColor = currentMode === 'A' ? 'rgba(2, 119, 189, 0.1)' : 'rgba(142, 36, 170, 0.1)';

        equityChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels, 
                datasets: [{
                    label: 'è³‡é‡‘æç›Š', 
                    data: data, 
                    borderColor: lineColor, 
                    backgroundColor: fillColor,
                    borderWidth: 2, 
                    pointRadius: 0, 
                    pointHoverRadius: 4,
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                scales: { 
                    x: { display: false }, 
                    y: { 
                        grid: { color: '#252525' },
                        ticks: { color: '#666' }
                    } 
                }
            }
        });
    }
</script>
</body>
</html>

