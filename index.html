<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 æ™ºèƒ½æ“ç›¤ç³»çµ± - Strategy B+ æ•´åˆç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- æ¨£å¼å€ (ç¶­æŒåŸæœ¬è¨­è¨ˆ) --- */
        :root {
            --bg-gradient: radial-gradient(circle at top left, #232526, #414345);
            --bg-dark: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(12px);
            --primary: #6366f1;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --card-radius: 16px;
            --btn-radius: 8px;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 24px; }

        header {
            text-align: center; padding: 24px; background: var(--glass-bg);
            border: 1px solid var(--glass-border); border-radius: var(--card-radius);
            backdrop-filter: var(--glass-blur); position: relative; overflow: hidden;
        }
        header::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        h1 { margin: 0; font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .mode-switcher { display: flex; gap: 12px; padding: 6px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; justify-content: center; border: 1px solid var(--glass-border); }
        .mode-btn { flex: 1; padding: 12px; border: none; border-radius: var(--btn-radius); cursor: pointer; font-size: 15px; font-weight: 600; color: var(--text-muted); background: transparent; transition: all 0.3s ease; }
        .mode-btn.active { color: white; background: rgba(255, 255, 255, 0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        body.mode-a .mode-btn.active#btnModeA { border-bottom: 2px solid var(--primary); }
        
        .status-container { background: var(--glass-bg); border-radius: var(--btn-radius); border: 1px solid var(--glass-border); overflow: hidden; position: relative; }
        .status-bar-content { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; gap: 15px; }
        .status-text-group { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
        #statusText { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .loading { color: var(--warning); } .success { color: var(--success); } .syncing { color: #38bdf8; }
        .data-info-block { display: flex; flex-direction: column; font-size: 12px; color: var(--text-muted); line-height: 1.4; }
        .data-count-highlight { color: var(--primary); font-weight: 700; }
        .btn-reset { background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); flex-shrink: 0; }
        
        .status-progress-bar { height: 3px; width: 100%; background: rgba(255, 255, 255, 0.05); position: absolute; bottom: 0; left: 0; }
        .status-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s ease; }
        .status-progress-fill.indeterminate { width: 30%; animation: loading-bar 1.5s infinite linear; }
        @keyframes loading-bar { 0% { left: -30%; } 100% { left: 100%; } }

        .dashboard { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media(min-width: 992px) { .dashboard { grid-template-columns: 1fr 1fr; } }

        .card { background: var(--glass-bg); padding: 24px; border-radius: var(--card-radius); border: 1px solid var(--glass-border); backdrop-filter: blur(16px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); position: relative; overflow: hidden; }
        .card h2 { margin-top: 0; font-size: 18px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .card-tag { font-size: 11px; background: linear-gradient(90deg, var(--primary), #818cf8); padding: 4px 10px; border-radius: 20px; color: white; font-weight: 600; }

        .strategy-control-panel { background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .control-row { display: flex; gap: 12px; align-items: stretch; }
        .select-wrapper { flex-grow: 2; position: relative; }
        .strategy-select { width: 100%; appearance: none; background: #1e293b; border: 1px solid #475569; color: white; padding: 12px 16px; border-radius: 8px; font-size: 15px; outline: none; cursor: pointer; font-family: 'Noto Sans TC', sans-serif; }
        .select-arrow { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); width: 12px; height: 12px; pointer-events: none; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #94a3b8; }
        .unit-input-group { display: flex; align-items: center; gap: 10px; background: #1e293b; border: 1px solid #475569; padding: 4px 12px; border-radius: 8px; }
        .unit-label { font-size: 13px; color: #cbd5e1; white-space: nowrap; font-weight: 500; }
        .unit-input { width: 50px; background: transparent; border: none; color: var(--warning); font-weight: 700; font-size: 16px; text-align: center; outline: none; padding: 8px 0; }
        .btn-switch { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; white-space: nowrap; }

        .strategy-box { background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; }
        .strategy-title { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; text-align: center; text-transform: uppercase; letter-spacing: 1px; }
        .strategy-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 16px; font-weight: 700; color: white; }
        .val-win { color: var(--success); } .val-loss { color: var(--danger); }

        .full-history-card { grid-column: 1 / -1; }
        .history-table-container { overflow-x: auto; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .full-history-table { width: 100%; border-collapse: collapse; font-size: 14px; white-space: nowrap; }
        .full-history-table th { background: rgba(30, 41, 59, 0.9); padding: 14px; color: var(--text-muted); font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.05); }
        .full-history-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); text-align: center; color: #e2e8f0; }
        .num-ball { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; font-size: 12px; margin: 0 2px; color: #94a3b8; background: #1e293b; font-weight: bold; }
        .num-hit { background: #f59e0b; color: black; box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
        .res-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 800; letter-spacing: 0.5px; }
        .badge-win { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-loss { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); opacity: 0.8; }

        .pagination { display: flex; justify-content: center; gap: 15px; margin-top: 20px; align-items: center; }
        .page-btn { background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .page-btn:hover { background: var(--primary); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-fetch { background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        
        .progress-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); z-index: 10; display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .progress-bar-bg { width: 60%; height: 6px; background: #334155; border-radius: 10px; overflow: hidden; margin-top: 15px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.3s; }
        
        .chart-container { position: relative; height: 350px; width: 100%; margin-top: 10px; }
        #manualInputSection { display: none; margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #ef4444, #991b1b); border-radius: 8px; text-align: center; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-box { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-icon { font-size: 40px; margin-bottom: 15px; }
        .modal-title { font-size: 20px; font-weight: 700; color: white; margin-bottom: 10px; }
        .modal-msg { font-size: 14px; color: #cbd5e1; margin-bottom: 25px; line-height: 1.6; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { flex: 1; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .modal-btn-cancel { background: #334155; color: white; }
        .modal-btn-confirm { background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; }
        .modal-btn-ok { background: linear-gradient(135deg, var(--primary), #4f46e5); color: white; }

        .prediction-text { text-align: center; font-size: 18px; color: var(--text-muted); padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; }
        .next-draw-info { text-align:center; padding:15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px;}
        
        .pred-balls { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap;}
        .pred-ball { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; font-weight: 800; line-height: 40px; text-align: center; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="mode-a">

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <div id="modalIcon" class="modal-icon">âš ï¸</div>
        <div id="modalTitle" class="modal-title"></div>
        <div id="modalMsg" class="modal-msg"></div>
        <div id="modalActions" class="modal-actions"></div>
    </div>
</div>

<div class="container">
    <header>
        <h1 id="app-title">Lotto 539 Trading System</h1>
    </header>

    <div class="mode-switcher">
        <button class="mode-btn active" id="btnModeA" onclick="setMode('A')">ğŸ”¥ ç­–ç•¥ B+ (çµæ§‹åŒ–å„ªé¸)</button>
        <button class="mode-btn" id="btnModeB" onclick="setMode('B')"> (æš«ç„¡å…¶ä»–)</button>
    </div>

    <div class="status-container">
        <div class="status-bar-content">
            <div class="status-text-group">
                <div id="statusText" class="loading">â³ ç³»çµ±å•Ÿå‹•ä¸­...</div>
                <div class="data-info-block" id="dataInfoBlock">
                    <span style="opacity:0.5;">ç­‰å¾…è¼‰å…¥...</span>
                </div>
            </div>
            <button class="btn-reset" onclick="resetAndReloadData()" id="btnResetData">ğŸ”„ é‡æ–°é©—è­‰æ•¸æ“š</button>
        </div>
        <div class="status-progress-bar">
            <div class="status-progress-fill" id="statusProgressBar"></div>
        </div>
    </div>

    <div id="manualInputSection">
        <p style="color:white; font-weight:bold;">âš ï¸ è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æœ€æ–°ä¸€æœŸè™Ÿç¢¼ï¼š</p>
        <input type="number" class="manual-input" id="m1">
        <input type="number" class="manual-input" id="m2">
        <input type="number" class="manual-input" id="m3">
        <input type="number" class="manual-input" id="m4">
        <input type="number" class="manual-input" id="m5">
        <button onclick="manualStart()" style="padding:5px 15px; cursor:pointer; color:black; background:white; border:none; border-radius:4px; font-weight:bold;">ç¢ºèª</button>
    </div>

    <div class="dashboard">
        <div class="card" id="card-backtest">
            <h2>
                <span>ğŸ’° ç­–ç•¥å›æ¸¬å ±å‘Š</span>
                <span class="card-tag" id="current-strategy-tag">Strategy B+</span>
            </h2>
            
            <div class="strategy-control-panel">
                <div class="control-row">
                    <div class="select-wrapper">
                        <select id="strategySelect" class="strategy-select">
                            <option value="strategy_b_plus">Strategy B+ (Python Ported)</option>
                        </select>
                        <div class="select-arrow"></div>
                    </div>
                </div>
                <div class="control-row">
                    <div class="unit-input-group">
                        <span class="unit-label">å€ç‡:</span>
                        <input type="number" id="baseUnit" class="unit-input" value="1" min="1">
                    </div>
                    <button class="btn-switch" onclick="runAnalysisWithLoading()">åŸ·è¡Œé‹ç®—</button>
                </div>
            </div>

            <div class="progress-overlay" id="loadingBar">
                <div style="color:white; font-weight:bold; font-size:16px;">AI é‹ç®—ä¸­...</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
            </div>
            
            <div class="strategy-box" id="strategyBox">
                <div class="strategy-title">
                    ğŸ“Š æ­·å²ç¸¾æ•ˆ (å…± <span id="real-test-count-disp" style="color:var(--primary);">--</span> æœŸ)
                </div>
                <div class="strategy-grid">
                    <div class="stat-item">
                        <div class="stat-label">ç´¯ç©æ·¨åˆ© (Net)</div>
                        <div class="stat-value val-win" id="st-profit">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æŠ•è³‡å ±é…¬ç‡ (ROI)</div>
                        <div class="stat-value val-win" id="st-roi">--%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å‹ç‡ (Win Rate)</div>
                        <div class="stat-value" id="st-winrate">--%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ç¸½ä¸‹æ³¨å–®æ•¸</div>
                        <div class="stat-value" id="st-count" style="color:#f472b6;">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€é«˜é€£å‹</div>
                        <div class="stat-value val-win" id="st-max-win">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€é«˜é€£æ•—</div>
                        <div class="stat-value val-loss" id="st-max-loss">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€å¤§å›æ’¤ (MDD)</div>
                        <div class="stat-value val-loss" id="st-mdd">--</div>
                    </div>
                    <div class="stat-item" style="opacity:0.6;">
                         <div class="stat-label">åƒæ•¸</div>
                         <div class="stat-value">B+</div>
                    </div>
                </div>
                <div id="strategy-desc" style="font-size:12px; color:var(--text-muted); margin-top:15px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.1);">
                    æ¬Šé‡: Trend/Gap | æ¿¾ç¶²: å¥‡å¶/å°¾æ•¸/å€é–“å¹³è¡¡
                </div>
            </div>
        </div>

        <div class="card">
            <h2>
                <span>ğŸ”® ä¸‹ä¸€æœŸé æ¸¬</span>
                <span class="card-tag" style="background:#ec4899;">Signal</span>
            </h2>
            
            <div class="next-draw-info">
                <div style="font-size:14px; color:var(--text-muted); margin-bottom:5px;">é æ¸¬é–‹çæ—¥</div>
                <div id="nextDrawDate" style="font-size:24px; font-weight:800; color:white; text-shadow:0 0 15px rgba(255,255,255,0.2);">--/--</div>
                <div id="nextWeekday" style="font-size:16px; color:var(--secondary); margin-top:4px; font-weight:bold;">é€±--</div>
            </div>

            <div id="prediction-panel">
                <div class="prediction-text" id="prediction-content">
                    ç­‰å¾…é‹ç®—...
                </div>
            </div>
            
            <button id="btnFetch" class="btn-fetch" onclick="forceFetchData()">
                <span id="fetchIcon">ğŸ”„</span> 
                <span id="fetchText">æ‰‹å‹•æŠ“å–æœ€æ–°æ•¸æ“š</span>
            </button>
        </div>
        
        <div class="card full-history-card">
            <h2>
                <span>ğŸ“œ è©³ç´°ä¸‹æ³¨æ­·å²ç´€éŒ„</span>
                <span class="card-tag">History</span>
            </h2>
            <div class="history-table-container">
                <table class="full-history-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é–‹çè™Ÿç¢¼</th>
                            <th>é æ¸¬çµ„åˆ (B+)</th>
                            <th>ä¸‹æ³¨æˆæœ¬</th>
                            <th>æ·¨æç›Š</th>
                            <th>çµæœ</th>
                        </tr>
                    </thead>
                    <tbody id="fullHistoryBody"></tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="page-btn" onclick="changePage(-1)">â—€ ä¸Šä¸€é </button>
                <span class="page-info" id="pageInfo">ç¬¬ 1 / 1 é </span>
                <button class="page-btn" onclick="changePage(1)">ä¸‹ä¸€é  â–¶</button>
            </div>
        </div>
        
        <div class="card full-history-card">
            <h2>
                <span>ğŸ“ˆ è³‡é‡‘æ¬Šç›Šèµ°å‹¢åœ–</span>
                <span class="card-tag" style="background:#10b981;">Equity Curve</span>
            </h2>
            <div class="chart-container">
                <canvas id="equityChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================
        //  è¨­å®šå€
        // ==========================================
        const DRIVE_FILE_ID = '1K2CNRIE97NRfJrzKiG8Adcz_tFeYHPlm';
        const STORAGE_KEY = 'lotto539_data_cache_v8_cloud'; 
        const BASE_URL = "https://www.lotto-8.com/listlto539.asp";
        const CRAWL_PAGES = 3;
        
        // --- Strategy B+ åƒæ•¸ç§»æ¤ ---
        const COST_PER_DAY = 2000;
        const PAYOUTS = {
            2: 5300,
            3: 72900,
            4: 1009800,
            5: 1009800
        };
        const STRATEGY_PARAMS = {
            w_short: 1.0,    
            w_mid: 3.0,      
            w_repeater: 0.0, 
            w_recent: 1.0,   
            w_cold: 3.0      
        };
        
        // æ ¸å¿ƒè®Šæ•¸
        let fullData = [];
        let globalTradeHistory = []; 
        let currentMode = 'A'; 
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;
        let equityChartInstance = null;

        window.onload = initSystem;

        // UI Helpers
        function setStatus(text, type = 'loading') {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.className = type;
            const bar = document.getElementById('statusProgressBar');
            if (type === 'loading' || type === 'syncing') {
                bar.classList.add('indeterminate');
            } else {
                bar.classList.remove('indeterminate');
                bar.style.width = '100%';
                setTimeout(() => { bar.style.width = '0%'; }, 1000);
            }
        }

        function showModal(type, title, msg) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').innerText = title;
                const msgEl = document.getElementById('modalMsg');
                msgEl.innerText = msg;
                msgEl.innerHTML = msg.replace(/\n/g, '<br>');
                const actionsEl = document.getElementById('modalActions');
                actionsEl.innerHTML = ''; 
                if (type === 'confirm') {
                    const btnCancel = document.createElement('button');
                    btnCancel.className = 'modal-btn modal-btn-cancel'; btnCancel.innerText = 'å–æ¶ˆ';
                    btnCancel.onclick = () => { modal.classList.remove('show'); setTimeout(() => { modal.style.display='none';},300); resolve(false); };
                    const btnConfirm = document.createElement('button');
                    btnConfirm.className = 'modal-btn modal-btn-confirm'; btnConfirm.innerText = 'ç¢ºå®š';
                    btnConfirm.onclick = () => { modal.classList.remove('show'); setTimeout(() => { modal.style.display='none';},300); resolve(true); };
                    actionsEl.appendChild(btnCancel); actionsEl.appendChild(btnConfirm);
                } else {
                    const btnOk = document.createElement('button');
                    btnOk.className = 'modal-btn modal-btn-ok'; btnOk.innerText = 'å¥½';
                    btnOk.onclick = () => { modal.classList.remove('show'); setTimeout(() => { modal.style.display='none';},300); resolve(true); };
                    actionsEl.appendChild(btnOk);
                }
                modal.style.display = 'flex'; setTimeout(()=>modal.classList.add('show'),10);
            });
        }

        // ==========================================
        //  æ•¸æ“šè™•ç† (Data Logic)
        // ==========================================
        async function fetchCloudData() {
            setStatus("â˜ï¸ ä¸‹è¼‰é›²ç«¯æ•¸æ“š...", 'syncing');
            const driveUrl = `https://drive.google.com/uc?export=download&id=${DRIVE_FILE_ID}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(driveUrl)}`;
            try {
                let res = await fetch(proxyUrl);
                if (!res.ok) throw new Error("Error");
                let data = await res.json();
                return data;
            } catch (error) {
                console.error("Cloud fetch failed", error);
                return []; 
            }
        }

        async function initSystem() {
            let cloudData = await fetchCloudData();
            let localData = [];
            const localStr = localStorage.getItem(STORAGE_KEY);
            if (localStr) { try { localData = JSON.parse(localStr); } catch(e) {} }

            let mergedMap = new Map();
            if (Array.isArray(cloudData)) cloudData.forEach(item => mergedMap.set(item.date, item));
            if (Array.isArray(localData)) localData.forEach(item => mergedMap.set(item.date, item));

            fullData = Array.from(mergedMap.values());
            // fullData æ’åºï¼šæ–°çš„åœ¨å‰é¢ [0] æ˜¯æœ€æ–°
            fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
            
            runAnalysisWithLoading();
            await forceFetchData(); 
        }

        async function resetAndReloadData() {
            const confirmed = await showModal('confirm', 'è³‡æ–™é‡ç½®', 'ç¢ºå®šè¦é‡æ–°ä¸‹è¼‰ä¸¦é©—è­‰æ•¸æ“šå—ï¼Ÿ');
            if (!confirmed) return;
            localStorage.removeItem(STORAGE_KEY);
            fullData = [];
            await initSystem();
            await showModal('success', 'å®Œæˆ', 'æ•¸æ“šå·²é‡ç½®ã€‚');
        }

        async function forceFetchData() {
            setStatus("ğŸ“¡ æª¢æŸ¥æ›´æ–°ä¸­...", 'syncing');
            const proxies = [
                url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&timestamp=${Date.now()}`,
                url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];
            let newData = [];
            let latestDate = (fullData.length > 0) ? fullData[0].date : "2000/01/01";
            try {
                for (let i = 1; i <= CRAWL_PAGES; i++) {
                    let targetUrl = i === 1 ? BASE_URL : `${BASE_URL}?indexpage=${i}&orderby=new`;
                    let html = null;
                    for (let proxy of proxies) {
                        try {
                            let res = await fetch(proxy(targetUrl));
                            let content = res.url.includes("allorigins") ? (await res.json()).contents : await res.text();
                            if (content && content.length > 500) { html = content; break; }
                        } catch(e){}
                    }
                    if(html) {
                        let parsed = parseHtml(html);
                        parsed.forEach(row => {
                            if(new Date(row.date) > new Date(latestDate)) newData.push(row);
                        });
                    }
                }
                if(newData.length>0) {
                    fullData = [...newData, ...fullData];
                    fullData.sort((a,b) => new Date(b.date) - new Date(a.date));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
                    setStatus(`âœ… æ›´æ–° ${newData.length} ç­†`, 'success');
                    runAnalysisWithLoading();
                } else {
                    setStatus("âœ… å·²æ˜¯æœ€æ–°", 'success');
                }
            } catch(e) { setStatus("âš ï¸ é€£ç·šå•é¡Œ", 'loading'); }
        }

        function parseHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            let results = [];
            doc.querySelectorAll("tr").forEach(row => {
                const text = row.innerText.trim();
                const dMatch = text.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                if (dMatch) {
                    let nums = text.match(/\d{2}/g);
                    if (nums && nums.length >= 5) {
                        let valid = [];
                        for (let i = nums.length - 1; i >= 0; i--) {
                            let n = parseInt(nums[i]);
                            if (n >= 1 && n <= 39 && !valid.includes(n)) valid.unshift(n);
                            if (valid.length === 5) break;
                        }
                        let dateStr = `${dMatch[1]}/${dMatch[2].padStart(2, '0')}/${dMatch[3].padStart(2, '0')}`;
                        if (valid.length === 5) results.push({ date: dateStr, numbers: valid });
                    }
                }
            });
            return results;
        }

        function manualStart() {
            let inputs = [1,2,3,4,5].map(i => parseInt(document.getElementById('m'+i).value));
            if(inputs.some(isNaN)) return;
            let today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            fullData.unshift({ date: today, numbers: inputs });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData));
            document.getElementById('manualInputSection').style.display = 'none';
            runAnalysisWithLoading();
        }

        // ==========================================
        //  Strategy B+ Logic Ported to JS
        // ==========================================
        
        // Helper: Generate combinations of k elements
        function getCombinations(arr, k) {
            let i, subI, ret = [], sub, next;
            for (i = 0; i < arr.length; i++) {
                if (k === 1) {
                    ret.push([arr[i]]);
                } else {
                    sub = getCombinations(arr.slice(i + 1), k - 1);
                    for (subI = 0; subI < sub.length; subI++) {
                        next = sub[subI];
                        next.unshift(arr[i]);
                        ret.push(next);
                    }
                }
            }
            return ret;
        }

        // Port of get_base_scores
        function getBaseScores(historyVals, params) {
            let scores = {};
            const shortWin = 5;
            const midWin = 12;
            const totalNumbers = 39;

            // Prepare flat lists (Javascript uses flat() or reduce)
            // historyVals is ordered [newest, ..., oldest]
            // Python's [-5:] means the 5 most recent. In our case, that is [0..4]
            
            let flatShort = [];
            if (historyVals.length >= shortWin) {
                for(let i=0; i<shortWin; i++) flatShort.push(...historyVals[i]);
            }
            
            let flatMid = [];
            if (historyVals.length >= midWin) {
                for(let i=0; i<midWin; i++) flatMid.push(...historyVals[i]);
            }

            // Calculate gaps
            // Iterate from end (oldest) to start (newest) to find most recent appearance
            let gapMap = {};
            for (let i = historyVals.length - 1; i >= 0; i--) {
                historyVals[i].forEach(n => {
                    gapMap[n] = i; // i is the index from 0 (most recent). So gap is i.
                });
            }

            for (let num = 1; num <= totalNumbers; num++) {
                let score = 0;
                // Frequency weights
                let countShort = flatShort.filter(x => x === num).length;
                let countMid = flatMid.filter(x => x === num).length;
                
                score += countShort * params.w_short;
                score += countMid * params.w_mid;

                // Gap weights
                // gapMap[num] stores index. index 0 is latest.
                // If num not in gapMap, gap is effectively infinite (or max history length)
                let gap = (gapMap[num] !== undefined) ? gapMap[num] : 999;

                if (gap === 0) score += params.w_repeater;
                else if (gap <= 4) score += params.w_recent;
                else if (gap > 10) score += params.w_cold;

                scores[num] = score;
            }
            return scores;
        }

        // Port of check_filters_structure
        function checkFiltersStructure(combo) {
            // 1. Odd/Even (3:2 or 2:3)
            let odds = combo.filter(n => n % 2 !== 0).length;
            if (odds !== 2 && odds !== 3) return false;

            // 2. Tail Diversity (no more than 2 same tails)
            let tails = combo.map(n => n % 10);
            let tailCounts = {};
            for (let t of tails) {
                tailCounts[t] = (tailCounts[t] || 0) + 1;
                if (tailCounts[t] > 2) return false;
            }

            // 3. 5-Segment Balance
            let segs = [0, 0, 0, 0, 0];
            for (let n of combo) {
                if (n <= 8) segs[0]++;
                else if (n <= 16) segs[1]++;
                else if (n <= 24) segs[2]++;
                else if (n <= 32) segs[3]++;
                else segs[4]++;
            }
            
            // Condition A: No segment > 2
            if (segs.some(s => s > 2)) return false;
            // Condition B: Span at least 3 segments
            if (segs.filter(s => s > 0).length < 3) return false;

            return true;
        }

        // Port of get_prediction
        function getPrediction(scores) {
            // Sort by score desc, take Top 14
            let sortedNums = Object.keys(scores)
                .map(n => parseInt(n))
                .sort((a, b) => scores[b] - scores[a])
                .slice(0, 14);

            let bestCombo = null;
            let maxComboScore = -Infinity;

            // Generate combinations C(14, 5) -> ~2002 checks (very fast in JS)
            let combos = getCombinations(sortedNums, 5);
            
            for (let combo of combos) {
                if (checkFiltersStructure(combo)) {
                    let currentScore = combo.reduce((sum, n) => sum + scores[n], 0);
                    if (currentScore > maxComboScore) {
                        maxComboScore = currentScore;
                        bestCombo = combo;
                    }
                }
            }

            // Fallback if filters are too strict
            if (!bestCombo) {
                bestCombo = sortedNums.slice(0, 5);
            }
            return bestCombo.sort((a,b) => a-b);
        }

        // ==========================================
        //  UI Integration & Backtest Execution
        // ==========================================

        function setMode(mode) {
            currentMode = mode;
            document.body.className = mode === 'A' ? 'mode-a' : 'mode-b';
            document.getElementById('btnModeA').className = mode === 'A' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btnModeB').className = mode === 'B' ? 'mode-btn active' : 'mode-btn';
            runAnalysisWithLoading();
        }

        function runAnalysisWithLoading() {
            const loading = document.getElementById('loadingBar');
            const fill = document.getElementById('progressFill');
            
            loading.style.display = 'flex';
            fill.style.width = '0%';
            setTimeout(() => { fill.style.width = '60%'; }, 200);
            
            setTimeout(() => { 
                fill.style.width = '100%';
                
                // Update Data Info
                const infoBlock = document.getElementById('dataInfoBlock');
                if (fullData.length > 0) {
                    infoBlock.innerHTML = `<div class="data-range-date">${fullData[fullData.length - 1].date} ~ ${fullData[0].date}</div><div class="data-count-highlight">åº«å­˜: ${fullData.length} æœŸ</div>`;
                }
                
                // Run Strategy B+ Backtest
                let multiplier = parseFloat(document.getElementById('baseUnit').value) || 1;
                let res = runBacktestJS(fullData, multiplier);
                
                // Update Stats
                updateStatBox(res);
                currentPage = 1;
                renderFullHistoryTable();
                updateEquityChart();
                
                // Run Prediction for Next Draw
                predictNextDraw();
                
                setTimeout(() => { loading.style.display = 'none'; }, 200);
            }, 500);
        }

        function runBacktestJS(data, multiplier) {
            globalTradeHistory = [];
            let totalCost = 0;
            let totalNet = 0;
            let winDays = 0;
            let tradingDays = 0;
            let currentEquity = 0;
            let peakEquity = 0;
            let maxDrawdown = 0;
            let maxWin = 0, currentWin = 0;
            let maxLoss = 0, currentLoss = 0;

            // Window Size 50 (from python script)
            const windowSize = 50;
            if (data.length < windowSize + 1) return { net: 0 };

            // Data is [New ... Old].
            // To simulate history similar to Python's loop:
            // Iterate from (length - windowSize - 1) down to 0
            
            for (let i = data.length - windowSize - 1; i >= 0; i--) {
                // historyVals: Data OLDER than i. i+1 to end.
                // We need to pass [newest_of_history ... oldest]
                // slice(i+1) gives us that.
                let historyData = data.slice(i + 1);
                let historyVals = historyData.map(d => d.numbers);
                
                let targetDraw = data[i];
                let targetNums = targetDraw.numbers;

                // 1. Calculate Scores
                let scores = getBaseScores(historyVals, STRATEGY_PARAMS);
                // 2. Get Prediction
                let predicted = getPrediction(scores);

                // 3. Calc Result
                let intersection = predicted.filter(x => targetNums.includes(x));
                let hits = intersection.length;
                
                // 4. Financials
                let cost = COST_PER_DAY * multiplier;
                let payout = (PAYOUTS[hits] || 0) * multiplier;
                let dailyNet = payout - cost;

                totalCost += cost;
                totalNet += dailyNet;
                currentEquity += dailyNet;
                
                if (currentEquity > peakEquity) peakEquity = currentEquity;
                let dd = currentEquity - peakEquity;
                if (dd < maxDrawdown) maxDrawdown = dd;

                if (dailyNet > 0) {
                    winDays++;
                    currentWin++; currentLoss = 0;
                    if(currentWin > maxWin) maxWin = currentWin;
                } else {
                    currentLoss++; currentWin = 0;
                    if(currentLoss > maxLoss) maxLoss = currentLoss;
                }
                tradingDays++;

                // Record History
                globalTradeHistory.push({
                    date: targetDraw.date,
                    numbers: targetDraw.numbers,
                    signal: predicted.join(', '),
                    targets: predicted, // for highlighting
                    cost: cost,
                    net: dailyNet,
                    isWin: dailyNet > 0,
                    hits: hits
                });
            }

            // globalTradeHistory is pushed from Old -> New order in loop? 
            // Loop goes i from big to 0 (Old to New). Yes.
            // So globalTradeHistory[0] is old.
            // But our table render expects [0] to be Newest. So we reverse.
            globalTradeHistory.reverse();

            return {
                cost: totalCost, net: totalNet, winDays: winDays, tradingDays: tradingDays,
                maxWin: maxWin, maxLoss: maxLoss, maxDrawdown: maxDrawdown
            };
        }

        function predictNextDraw() {
            if(fullData.length === 0) return;
            let nextDate = getNextDrawDate(fullData[0].date);
            document.getElementById('nextDrawDate').innerText = nextDate.dateStr;
            document.getElementById('nextWeekday').innerText = nextDate.weekdayStr;
            
            // Use ALL available data as history
            let historyVals = fullData.map(d => d.numbers);
            let scores = getBaseScores(historyVals, STRATEGY_PARAMS);
            let prediction = getPrediction(scores);

            let html = `
                <div style="font-size:16px; color:var(--text-main); margin-bottom:10px;">
                    Strategy B+ æ¨è–¦çµ„åˆ
                </div>
                <div class="pred-balls">
                    ${prediction.map(n => `<div class="pred-ball">${n < 10 ? '0'+n : n}</div>`).join('')}
                </div>
                <div style="margin-top:15px; font-size:12px; color:var(--text-muted);">
                    å–®æ³¨æˆæœ¬: $${COST_PER_DAY.toLocaleString()} <br>
                    (å·²å¥—ç”¨ å¥‡å¶/å°¾æ•¸/å€é–“ å¹³è¡¡æ¿¾ç¶²)
                </div>
            `;
            document.getElementById('prediction-content').innerHTML = html;
        }

        function getNextDrawDate(lastDateStr) {
            let last = new Date(lastDateStr);
            let next = new Date(last);
            next.setDate(last.getDate() + 1);
            if(next.getDay() === 0) next.setDate(next.getDate() + 1);
            let m = (next.getMonth()+1).toString().padStart(2,'0');
            let d = next.getDate().toString().padStart(2,'0');
            let w = "æ—¥ä¸€äºŒä¸‰å››äº”å…­"[next.getDay()];
            return { dateStr: `${m}/${d}`, weekdayStr: `é€±${w}` };
        }

        function updateStatBox(res) {
            document.getElementById('st-profit').innerText = `$${res.net.toLocaleString()}`;
            document.getElementById('st-profit').className = res.net > 0 ? "stat-value val-win" : "stat-value val-loss";
            document.getElementById('st-roi').innerText = (res.cost > 0 ? (res.net/res.cost*100).toFixed(1) : 0) + "%";
            document.getElementById('st-winrate').innerText = (res.tradingDays > 0 ? (res.winDays/res.tradingDays*100).toFixed(1) : 0) + "%";
            document.getElementById('st-count').innerText = res.tradingDays;
            document.getElementById('st-max-win').innerText = res.maxWin;
            document.getElementById('st-max-loss').innerText = res.maxLoss;
            document.getElementById('st-mdd').innerText = `$${res.maxDrawdown.toLocaleString()}`;
            document.getElementById('real-test-count-disp').innerText = fullData.length;
        }

        // ==========================================
        //  UI Rendering (Tables & Charts)
        // ==========================================
        function changePage(delta) {
            const totalPages = Math.ceil(globalTradeHistory.length / ITEMS_PER_PAGE);
            let newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderFullHistoryTable();
            }
        }

        function renderFullHistoryTable() {
            const tbody = document.getElementById('fullHistoryBody');
            const pageInfo = document.getElementById('pageInfo');
            const totalItems = globalTradeHistory.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
            
            tbody.innerHTML = '';
            pageInfo.innerText = `ç¬¬ ${currentPage} / ${totalPages} é  (å…± ${totalItems} ç­†)`;

            if(totalItems === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; color:#666;">ç„¡äº¤æ˜“ç´€éŒ„</td></tr>';
                return;
            }

            let start = (currentPage - 1) * ITEMS_PER_PAGE;
            let end = Math.min(start + ITEMS_PER_PAGE, totalItems);

            for (let i = start; i < end; i++) {
                let row = globalTradeHistory[i];
                let tr = document.createElement('tr');
                
                // Highlight matches in the DRAW numbers
                let numsHtml = row.numbers.map(n => {
                    let className = "num-ball";
                    // If this drawn number was in our prediction target, highlight it
                    if (row.targets && row.targets.includes(n)) className += " num-hit";
                    return `<span class="${className}">${n<10?'0'+n:n}</span>`;
                }).join('');

                let resBadge = row.isWin ? `<span class="res-badge badge-win">WIN</span>` : `<span class="res-badge badge-loss">LOSS</span>`;
                let netColor = row.net > 0 ? "var(--success)" : "var(--danger)";

                tr.innerHTML = `
                    <td style="color:#bdc3c7">${row.date.slice(5)}</td>
                    <td>${numsHtml}</td>
                    <td style="color:var(--warning); font-size:12px;">${row.signal}</td>
                    <td>$${row.cost.toLocaleString()}</td>
                    <td style="color:${netColor}; font-weight:bold;">${row.net > 0 ? '+' : ''}$${row.net.toLocaleString()}</td>
                    <td>${resBadge}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function updateEquityChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            // globalTradeHistory is Newest -> Oldest. 
            // For chart we need Oldest -> Newest.
            let chronoHistory = [...globalTradeHistory].reverse();
            let labels = chronoHistory.map(d => d.date); 
            let data = [];
            let accum = 0;
            
            chronoHistory.forEach(d => {
                accum += d.net;
                data.push(accum);
            });
            
            if (equityChartInstance) equityChartInstance.destroy();
            
            let gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); 
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            equityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'ç´¯ç©æç›Š (Equity)',
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#bdc3c7' } }
                    }
                }
            });
        }
    </script>
</div>
</body>
</html>

